#!/bin/sh

# Source the service-setup script to access shared functions and variables
. "$(dirname $0)/service-setup"

# Log the start of post-uninstallation process
install_log "Starting post-uninstallation cleanup for $PACKAGE"

# Create backup directory if it doesn't exist
if [ ! -d "$SYNOPKG_PKGDEST/../$PACKAGE_BACKUP_DIR" ]; then
    install_log "Creating backup directory at $SYNOPKG_PKGDEST/../$PACKAGE_BACKUP_DIR"
    mkdir -p "$SYNOPKG_PKGDEST/../$PACKAGE_BACKUP_DIR"
    if [ $? -ne 0 ]; then
        install_log "Error: Failed to create backup directory"
    fi
fi

# Backup configuration files if they exist
if [ -d "$INSTALL_DIR/config" ]; then
    install_log "Backing up configuration files to $SYNOPKG_PKGDEST/../$PACKAGE_BACKUP_DIR/config"
    cp -rf "$INSTALL_DIR/config" "$SYNOPKG_PKGDEST/../$PACKAGE_BACKUP_DIR/"
    if [ $? -ne 0 ]; then
        install_log "Warning: Failed to backup configuration files"
    fi
fi

# Remove symlinks
if [ -L "/usr/local/bin/playit" ]; then
    install_log "Removing symlink from /usr/local/bin/playit"
    rm -f /usr/local/bin/playit
    if [ $? -ne 0 ]; then
        install_log "Warning: Failed to remove symlink from /usr/local/bin/playit"
    fi
fi

# Clean up log directory if exists
if [ -d "$LOG_DIR" ]; then
    install_log "Cleaning up log directory at $LOG_DIR"
    rm -rf "$LOG_DIR"
    if [ $? -ne 0 ]; then
        install_log "Warning: Failed to remove log directory"
    fi
fi

# Remove the service user
install_log "Removing service user $USER"
manage_service_user "remove"
if [ $? -ne 0 ]; then
    install_log "Warning: Failed to remove service user $USER"
fi

# Remove any leftover directories in /var/packages except backup data
install_log "Cleaning up package directories"
if [ -d "$INSTALL_DIR" ] && [ "$INSTALL_DIR" != "/" ]; then
    rm -rf "$INSTALL_DIR"
    if [ $? -ne 0 ]; then
        install_log "Warning: Failed to remove installation directory $INSTALL_DIR"
    fi
fi

# Final log message
install_log "Post-uninstallation cleanup for $PACKAGE completed successfully"

exit 0

#!/bin/sh
. $(dirname $0)/installer
$(basename $0) > $SYNOPKG_TEMP_LOGFILE
