#!/bin/sh


# "c113ce3d302ac279f60912ceae77c31d686179b3462073dc3f71ac6ed84e090f"
# Package name
PACKAGE="playitGG"
DNAME="${SYNOPKG_PKGNAME}"
LOG_FILE="${SYNOPKG_PKGVAR}/${SYNOPKG_PKGNAME}.log"
INSTALL_DIR="/var/packages/${PACKAGE}/target"
PID_FILE="${INSTALL_DIR}/playit.pid"
PLAYIT_BIN="${INSTALL_DIR}/bin/playit-linux"
PLAYIT_SECRET="c113ce3d302ac279f60912ceae77c31d686179b3462073dc3f71ac6ed84e090f"

# Load environment variables
if [ -f "/var/packages/${PACKAGE}/var/config" ]; then
    . "/var/packages/${PACKAGE}/var/config"
fi

# Check if secret is provided
if [ -z "${PLAYIT_SECRET}" ]; then
    echo "Error: PLAYIT_SECRET is not set" >> $LOG_FILE
    exit 1
fi

# Start the package
start_daemon() {
    if [ -f ${PID_FILE} ] && kill -0 $(cat ${PID_FILE}) > /dev/null 2>&1; then
        echo "${DNAME} is already running" >> $LOG_FILE
        exit 0
    fi

    if [ ! -x "${PLAYIT_BIN}" ]; then
        echo "Error: Playit binary not found or not executable" >> $LOG_FILE
        exit 1
    fi

    echo "Starting ${DNAME} ..." >> $LOG_FILE
    cd ${INSTALL_DIR}
    nohup ${PLAYIT_BIN} --secret "${PLAYIT_SECRET}" >> $LOG_FILE 2>&1 &
    echo $! > ${PID_FILE}
    echo "${DNAME} started with PID $(cat ${PID_FILE})" >> $LOG_FILE
}

# Stop the package
stop_daemon() {
    if [ ! -f ${PID_FILE} ] || ! kill -0 $(cat ${PID_FILE}) > /dev/null 2>&1; then
        echo "${DNAME} is not running" >> $LOG_FILE
        exit 0
    fi

    echo "Stopping ${DNAME} ..." >> $LOG_FILE
    kill $(cat ${PID_FILE}) && rm -f ${PID_FILE}
}

# Get the status of the package
daemon_status() {
    if [ -f ${PID_FILE} ] && kill -0 $(cat ${PID_FILE}) > /dev/null 2>&1; then
        echo "${DNAME} is running"
        exit 0
    else
        echo "${DNAME} is not running"
        exit 1
    fi
}

case $1 in
    start)
        start_daemon
        ;;
    stop)
        stop_daemon
        ;;
    status)
        daemon_status
        ;;
    *)
        echo "Usage: $0 {start|stop|status}"
        exit 1
        ;;
esac

exit 0

